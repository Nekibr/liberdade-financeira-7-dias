<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ferramenta Interativa: Planejamento Financeiro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome CDN for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Estilos para os botões de navegação aprimorados */
        .nav-button {
            transition: all 0.3s ease;
            background-color: white;
            color: #10B981; /* Emerald 600 */
            border: 1px solid #D1FAE5; /* Emerald 100 */
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .nav-button.active {
            background-color: #10B981; /* Emerald 500 */
            color: white;
            box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3);
            transform: translateY(-2px);
        }
        .nav-button:not(.active):hover {
            background-color: #D1FAE5; /* Emerald 100 */
            color: #065F46; /* Emerald 900 */
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .content-section { display: none; }
        .content-section.active { display: block; }
        .chart-container { position: relative; width: 100%; max-width: 400px; margin-left: auto; margin-right: auto; height: 300px; max-height: 350px; }
        @media (min-width: 768px) { .chart-container { height: 350px; } }
        .debt-item:not(:last-child) { border-bottom: 1px solid #e5e7eb; }
        strong, b { font-weight: bold; }
        .goal-progress-bar {
            width: 100%;
            background-color: #e2e8f0; /* Tailwind slate-200 */
            border-radius: 9999px; /* full rounded */
            height: 12px; /* h-3 */
            overflow: hidden;
            margin-top: 0.5rem;
        }
        .goal-progress {
            height: 100%;
            background-color: #10B981; /* Emerald 500 */
            border-radius: 9999px;
            transition: width 0.5s ease-in-out;
        }
    </style>
</head>
<body class="bg-stone-50 text-slate-800 leading-relaxed">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <!-- Seção da Ferramenta Interativa -->
        <section id="financas-interativa" class="bg-white p-6 rounded-2xl shadow-lg">
            <header class="text-center mb-8">
                <h1 class="text-3xl md:text-4xl font-bold text-emerald-600">Ferramenta Interativa: Planejamento Financeiro</h1>
                <p class="mt-2 text-slate-600">Aplique os conceitos do Método 7 Dias de forma prática e visualize seu progresso.</p>
            </header>

            <nav class="flex flex-wrap justify-center gap-2 md:gap-4 mb-8">
                <button data-target="passo1" class="nav-button active font-medium py-2 px-4 rounded-full">Passo 1: Orçamento</button>
                <button data-target="passo2" class="nav-button font-medium py-2 px-4 rounded-full">Passo 2: Plano de Dívidas</button>
                <button data-target="passo3" class="nav-button font-medium py-2 px-4 rounded-full">Passo 3: Metas e Futuro</button>
                <button data-target="passo4-investimento" class="nav-button font-medium py-2 px-4 rounded-full">Passo 4: Investimentos</button>
                <button data-target="passo5-financiamento" class="nav-button font-medium py-2 px-4 rounded-full">Passo 5: Financiamento</button>
                <button data-target="passo6-fluxo-caixa" class="nav-button font-medium py-2 px-4 rounded-full">Passo 6: Fluxo de Caixa Futuro</button>
                <button data-target="passo7-patrimonio" class="nav-button font-medium py-2 px-4 rounded-full">Passo 7: Meu Patrimônio Líquido</button>
            </nav>

            <main>
                <!-- Seção 1: Raio-X Financeiro e Orçamento -->
                <section id="passo1" class="content-section active">
                    <div class="bg-white p-6 rounded-2xl shadow-sm">
                        <h2 class="text-2xl font-bold mb-1 text-emerald-600">Passo 1: Raio-X Financeiro</h2>
                        <p class="text-slate-600 mb-6">O primeiro passo é entender para onde seu dinheiro está indo. Preencha os campos abaixo para criar seu orçamento mensal e visualizar sua saúde financeira.</p>
                        
                        <div class="grid md:grid-cols-2 gap-8 items-start">
                            <!-- Lado Esquerdo: Inputs -->
                            <div>
                                <div class="mb-4">
                                    <label for="income" class="block font-medium mb-1">Sua Renda Mensal Líquida (R$)</label>
                                    <input type="number" id="income" placeholder="Ex: 3000" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-400 focus:outline-none">
                                </div>

                                <div class="mb-4">
                                    <h3 class="font-bold text-lg mb-2">Adicionar Despesa</h3>
                                    <div class="grid sm:grid-cols-2 gap-2">
                                        <input type="text" id="expense-name" placeholder="Nome da despesa" class="p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-400 focus:outline-none">
                                        <input type="number" id="expense-amount" placeholder="Valor (R$)" class="p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-400 focus:outline-none">
                                        <select id="expense-category" class="col-span-2 sm:col-span-1 p-2 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-emerald-400 focus:outline-none">
                                            <option value="necessidades">Necessidades</option>
                                            <option value="desejos">Desejos</option>
                                            <option value="dividas">Dívidas</option>
                                        </select>
                                        <button id="add-expense" class="col-span-2 sm:col-span-1 bg-emerald-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-emerald-600 transition">Adicionar</button>
                                    </div>
                                </div>
                                
                                <div id="expense-list" class="space-y-2 mt-4 max-h-60 overflow-y-auto pr-2">
                                    <!-- Despesas serão adicionadas aqui -->
                                </div>
                            </div>

                            <!-- Lado Direito: Visualização -->
                            <div class="bg-stone-50 p-4 rounded-xl">
                                <h3 class="font-bold text-lg mb-4 text-center">Distribuição de Gastos</h3>
                                <div class="chart-container">
                                    <canvas id="budgetChart"></canvas>
                                </div>
                                <div id="summary" class="text-center mt-4 font-semibold text-xl">
                                    Saldo: R$ 0,00
                                </div>
                                <div class="mt-4 pt-4 border-t">
                                    <h4 class="font-bold text-center mb-2">Comparativo: Você vs. Regra 50/30/20</h4>
                                    <div id="comparison-bars" class="space-y-2 text-sm">
                                        <!-- Barras de comparação -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Seção 2: Plano de Dívidas -->
                <section id="passo2" class="content-section">
                    <div class="bg-white p-6 rounded-2xl shadow-sm">
                        <h2 class="text-2xl font-bold mb-1 text-emerald-600">Passo 2: Monte seu Plano de Dívidas</h2>
                        <p class="text-slate-600 mb-6">Liste suas dívidas e escolha uma estratégia para quitá-las. A ferramenta irá organizar a prioridade para você focar seus esforços.</p>
                        
                        <div class="grid md:grid-cols-2 gap-8">
                            <div>
                                <h3 class="font-bold text-lg mb-2">Adicionar Dívida</h3>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mb-4 p-4 bg-stone-50 rounded-lg">
                                    <input type="text" id="debt-name" placeholder="Nome da dívida" class="sm:col-span-2 p-2 border rounded-lg">
                                    <input type="number" id="debt-total" placeholder="Valor Total (R$)" class="p-2 border rounded-lg">
                                    <input type="number" id="debt-rate" placeholder="Juros (% a.m.)" class="p-2 border rounded-lg">
                                    <button id="add-debt" class="sm:col-span-2 bg-emerald-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-emerald-600 transition">Adicionar Dívida</button>
                                </div>
                                <div class="mt-4">
                                    <h3 class="font-bold text-lg mb-2">Escolha sua Estratégia</h3>
                                    <div class="flex gap-2 mb-4">
                                        <button id="snowball-btn" class="flex-1 bg-emerald-200 text-emerald-800 p-2 rounded-lg font-medium">Bola de Neve</button>
                                        <button id="avalanche-btn" class="flex-1 bg-gray-200 p-2 rounded-lg font-medium">Avalancha</button>
                                    </div>
                                    <p id="strategy-explanation" class="text-sm text-slate-600 p-3 bg-blue-50 rounded-lg"><b>Método Bola de Neve:</b> Pague as dívidas da menor para a maior. Ideal para ganhar motivação rápida.</p>
                                </div>
                                <!-- Simulador de Quitação de Dívidas -->
                                <div class="mt-6 pt-6 border-t border-gray-200">
                                    <h3 class="font-bold text-lg mb-2">Simulador de Quitação Rápida</h3>
                                    <p class="text-sm text-slate-600 mb-2">Veja em quanto tempo você quitaria a dívida prioritária pagando um valor extra por mês:</p>
                                    <input type="number" id="extra-payment" placeholder="Pagamento Extra Mensal (R$)" class="w-full p-2 border rounded-lg mb-2">
                                    <div id="debt-simulation-result" class="bg-blue-100 text-blue-800 p-3 rounded-lg text-sm">
                                        Adicione dívidas e um valor extra para simular.
                                    </div>
                                </div>
                            </div>
                        
                            <div>
                                <h3 class="font-bold text-lg mb-2">Sua Lista de Prioridades</h3>
                                <div id="debt-list" class="bg-stone-50 rounded-lg p-2 min-h-[200px]">
                                    <!-- Dívidas listadas aqui -->
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Seção 3: Metas e Futuro -->
                <section id="passo3" class="content-section">
                    <div class="bg-white p-6 rounded-2xl shadow-sm">
                        <h2 class="text-2xl font-bold mb-1 text-emerald-600">Passo 3: Construindo seu Futuro</h2>
                        <p class="text-slate-600 mb-6">Defina suas metas e entenda os primeiros passos para poupar e investir. Ter um propósito claro é o que mantém a motivação.</p>
                        
                        <div class="grid md:grid-cols-2 gap-8">
                            <!-- Calculadora Reserva -->
                            <div class="bg-stone-50 p-6 rounded-xl">
                                <h3 class="font-bold text-lg mb-2">Calculadora de Reserva de Emergência</h3>
                                <p class="text-sm text-slate-600 mb-4">Sua reserva deve cobrir de 3 a 6 meses de seus custos essenciais.</p>
                                <label for="essential-costs" class="block font-medium mb-1">Seu Custo de Vida Essencial Mensal (R$)</label>
                                <input type="number" id="essential-costs" placeholder="Ex: 1500" class="w-full p-2 border rounded-lg mb-4">
                                <div id="emergency-fund-result" class="text-center bg-emerald-100 text-emerald-800 p-4 rounded-lg">
                                    <p class="font-bold">Sua meta de reserva é:</p>
                                    <p class="text-2xl font-bold">R$ 0,00 - R$ 0,00</p>
                                </div>
                            </div>

                            <!-- Metas SMART -->
                            <div class="bg-stone-50 p-6 rounded-xl">
                                <h3 class="font-bold text-lg mb-2">Defina Suas Metas (SMART)</h3>
                                <p class="text-sm text-slate-600 mb-4">Metas devem ser Específicas, Mensuráveis, Atingíveis, Relevantes e com Prazo.</p>
                                <div class="space-y-2 mb-4">
                                    <input type="text" id="goal-name" placeholder="Ex: Viagem para a praia" class="w-full p-2 border rounded-lg">
                                    <input type="number" id="goal-target-amount" placeholder="Valor Total da Meta (R$)" class="w-full p-2 border rounded-lg">
                                    <input type="number" id="goal-saved-amount" placeholder="Valor Já Economizado (R$)" class="w-full p-2 border rounded-lg">
                                    <button id="add-goal" class="w-full bg-emerald-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-emerald-600 transition">Adicionar Meta</button>
                                </div>
                                <div id="goal-list" class="mt-4 space-y-4"></div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Seção 4: Simulador de Investimentos -->
                <section id="passo4-investimento" class="content-section">
                    <div class="bg-white p-6 rounded-2xl shadow-sm">
                        <h2 class="text-2xl font-bold mb-1 text-emerald-600">Passo 4: Simulador de Investimentos</h2>
                        <p class="text-slate-600 mb-6">Explore o poder dos juros compostos! Veja quanto seu dinheiro pode render ao longo do tempo.</p>
                        
                        <div class="grid md:grid-cols-2 gap-8">
                            <div>
                                <div class="mb-4">
                                    <label for="initial-capital" class="block font-medium mb-1">Capital Inicial (R$)</label>
                                    <input type="number" id="initial-capital" placeholder="Ex: 1000" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-400 focus:outline-none">
                                </div>
                                <div class="mb-4">
                                    <label for="monthly-contribution" class="block font-medium mb-1">Aporte Mensal (R$)</label>
                                    <input type="number" id="monthly-contribution" placeholder="Ex: 200" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-400 focus:outline-none">
                                </div>
                                <div class="mb-4">
                                    <label for="annual-interest-rate" class="block font-medium mb-1">Taxa de Juros Anual (%)</label>
                                    <input type="number" id="annual-interest-rate" placeholder="Ex: 8" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-400 focus:outline-none">
                                </div>
                                <div class="mb-4">
                                    <label for="investment-period-years" class="block font-medium mb-1">Período (Anos)</label>
                                    <input type="number" id="investment-period-years" placeholder="Ex: 10" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-400 focus:outline-none">
                                </div>
                                <button id="calculate-investment" class="w-full bg-emerald-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-emerald-600 transition">Simular Investimento</button>
                            </div>
                            <div class="bg-stone-50 p-6 rounded-xl flex items-center justify-center">
                                <div id="investment-result" class="text-center text-slate-700">
                                    <p>Preencha os campos para ver a simulação do seu investimento.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Seção 5: Simulador de Financiamento -->
                <section id="passo5-financiamento" class="content-section">
                    <div class="bg-white p-6 rounded-2xl shadow-sm">
                        <h2 class="text-2xl font-bold mb-1 text-emerald-600">Passo 5: Simulador de Financiamento</h2>
                        <p class="text-slate-600 mb-6">Calcule o valor das parcelas e o custo total do seu financiamento.</p>
                        
                        <div class="grid md:grid-cols-2 gap-8">
                            <div>
                                <div class="mb-4">
                                    <label for="property-value" class="block font-medium mb-1">Valor do Imóvel/Bem (R$)</label>
                                    <input type="number" id="property-value" placeholder="Ex: 300000" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-400 focus:outline-none">
                                </div>
                                <div class="mb-4">
                                    <label for="down-payment-percentage" class="block font-medium mb-1">Entrada (%)</label>
                                    <input type="number" id="down-payment-percentage" placeholder="Ex: 20" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-400 focus:outline-none">
                                </div>
                                <div class="mb-4">
                                    <label for="annual-financing-rate" class="block font-medium mb-1">Taxa de Juros Anual (%)</label>
                                    <input type="number" id="annual-financing-rate" placeholder="Ex: 9.5" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-400 focus:outline-none">
                                </div>
                                <div class="mb-4">
                                    <label for="financing-period-years" class="block font-medium mb-1">Período (Anos)</label>
                                    <input type="number" id="financing-period-years" placeholder="Ex: 30" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-400 focus:outline-none">
                                </div>
                                <button id="calculate-financing" class="w-full bg-emerald-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-emerald-600 transition">Simular Financiamento</button>
                            </div>
                            <div class="bg-stone-50 p-6 rounded-xl flex items-center justify-center">
                                <div id="financing-result" class="text-center text-slate-700">
                                    <p>Preencha os campos para ver a simulação do seu financiamento.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Seção 6: Previsão de Fluxo de Caixa Detalhada -->
                <section id="passo6-fluxo-caixa" class="content-section">
                    <div class="bg-white p-6 rounded-2xl shadow-sm">
                        <h2 class="text-2xl font-bold mb-1 text-emerald-600">Passo 6: Previsão de Fluxo de Caixa Futuro</h2>
                        <p class="text-slate-600 mb-6">Planeje e visualize seu saldo financeiro para os próximos meses, incluindo eventos futuros.</p>
                        
                        <div class="grid md:grid-cols-2 gap-8 items-start">
                            <!-- Inputs para Eventos Futuros -->
                            <div>
                                <h3 class="font-bold text-lg mb-2">Adicionar Evento Futuro</h3>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mb-4 p-4 bg-stone-50 rounded-lg">
                                    <input type="text" id="event-name" placeholder="Nome do evento" class="sm:col-span-2 p-2 border rounded-lg">
                                    <input type="number" id="event-amount" placeholder="Valor (R$)" class="p-2 border rounded-lg">
                                    <input type="date" id="event-date" class="p-2 border rounded-lg">
                                    <select id="event-type" class="p-2 border rounded-lg bg-white">
                                        <option value="income">Receita</option>
                                        <option value="expense">Despesa</option>
                                    </select>
                                    <button id="add-future-event" class="sm:col-span-2 bg-emerald-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-emerald-600 transition">Adicionar Evento</button>
                                </div>
                                <div id="future-event-list" class="space-y-2 mt-4 max-h-60 overflow-y-auto pr-2">
                                    <!-- Eventos futuros serão adicionados aqui -->
                                </div>
                            </div>

                            <!-- Configurações e Tabela de Projeção -->
                            <div class="bg-stone-50 p-6 rounded-xl">
                                <h3 class="font-bold text-lg mb-2">Configurações da Projeção</h3>
                                <div class="mb-4">
                                    <label for="projection-start-month" class="block font-medium mb-1">Mês de Início</label>
                                    <select id="projection-start-month" class="w-full p-2 border rounded-lg bg-white">
                                        <!-- Opções de meses geradas por JS -->
                                    </select>
                                </div>
                                <div class="mb-4">
                                    <label for="projection-start-year" class="block font-medium mb-1">Ano de Início</label>
                                    <input type="number" id="projection-start-year" class="w-full p-2 border rounded-lg">
                                </div>
                                <div class="mb-4">
                                    <label for="projection-months" class="block font-medium mb-1">Meses para Projetar</label>
                                    <input type="number" id="projection-months" value="12" min="1" max="60" class="w-full p-2 border rounded-lg">
                                </div>
                                <button id="calculate-cash-flow" class="w-full bg-emerald-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-emerald-600 transition">Gerar Projeção</button>

                                <div id="cash-flow-projection-result" class="mt-6 pt-4 border-t border-gray-200">
                                    <h3 class="font-bold text-lg mb-2">Sua Projeção de Fluxo de Caixa</h3>
                                    <div class="overflow-x-auto">
                                        <table class="min-w-full bg-white rounded-lg shadow-sm text-sm">
                                            <thead>
                                                <tr class="bg-gray-100 text-left">
                                                    <th class="py-2 px-3 border-b">Mês/Ano</th>
                                                    <th class="py-2 px-3 border-b">Saldo Inicial</th>
                                                    <th class="py-2 px-3 border-b">Receitas (Eventos)</th>
                                                    <th class="py-2 px-3 border-b">Despesas (Eventos)</th>
                                                    <th class="py-2 px-3 border-b">Saldo Final</th>
                                                </tr>
                                            </thead>
                                            <tbody id="projection-table-body">
                                                <tr><td colspan="5" class="text-center py-4 text-slate-400">Gere a projeção para visualizar.</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <!-- Novo elemento para o gráfico de fluxo de caixa -->
                                    <div class="mt-6">
                                        <h3 class="font-bold text-lg mb-2 text-center">Gráfico de Fluxo de Caixa</h3>
                                        <div class="chart-container">
                                            <canvas id="cashFlowChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Seção 7: Meu Patrimônio Líquido -->
                <section id="passo7-patrimonio" class="content-section">
                    <div class="bg-white p-6 rounded-2xl shadow-sm">
                        <h2 class="text-2xl font-bold mb-1 text-emerald-600">Passo 7: Meu Patrimônio Líquido</h2>
                        <p class="text-slate-600 mb-6">Calcule e acompanhe a evolução do seu patrimônio líquido. A verdadeira medida da sua riqueza!</p>
                        
                        <div class="grid md:grid-cols-2 gap-8 items-start">
                            <div>
                                <!-- Adicionar Ativos -->
                                <h3 class="font-bold text-lg mb-2">Adicionar Ativo</h3>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mb-4 p-4 bg-stone-50 rounded-lg">
                                    <input type="text" id="asset-name" placeholder="Nome do ativo (Ex: Poupança, Carro)" class="sm:col-span-2 p-2 border rounded-lg">
                                    <input type="number" id="asset-value" placeholder="Valor (R$)" class="p-2 border rounded-lg">
                                    <button id="add-asset" class="sm:col-span-2 bg-emerald-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-emerald-600 transition">Adicionar Ativo</button>
                                </div>
                                <div id="asset-list" class="space-y-2 mt-4 max-h-40 overflow-y-auto pr-2">
                                    <!-- Ativos serão adicionados aqui -->
                                </div>

                                <!-- Adicionar Passivos -->
                                <h3 class="font-bold text-lg mb-2 mt-6">Adicionar Passivo</h3>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mb-4 p-4 bg-stone-50 rounded-lg">
                                    <input type="text" id="liability-name" placeholder="Nome do passivo (Ex: Dívida Cartão, Financiamento)" class="sm:col-span-2 p-2 border rounded-lg">
                                    <input type="number" id="liability-value" placeholder="Valor (R$)" class="p-2 border rounded-lg">
                                    <button id="add-liability" class="sm:col-span-2 bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition">Adicionar Passivo</button>
                                </div>
                                <div id="liability-list" class="space-y-2 mt-4 max-h-40 overflow-y-auto pr-2">
                                    <!-- Passivos serão adicionados aqui -->
                                </div>

                                <div class="mt-6 pt-6 border-t border-gray-200">
                                    <button id="record-net-worth" class="w-full bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition">Registrar Patrimônio Atual</button>
                                    <p class="text-sm text-slate-600 mt-2 text-center">Isso salvará o seu patrimônio líquido atual para acompanhar a evolução.</p>
                                </div>
                            </div>

                            <!-- Resumo e Gráfico de Patrimônio Líquido -->
                            <div class="bg-stone-50 p-6 rounded-xl">
                                <h3 class="font-bold text-lg mb-2 text-center">Seu Patrimônio Líquido Atual</h3>
                                <div id="net-worth-summary" class="text-center mb-4">
                                    <p class="text-sm text-slate-600">Total de Ativos: <span class="font-bold text-emerald-600" id="total-assets">R$ 0,00</span></p>
                                    <p class="text-sm text-slate-600">Total de Passivos: <span class="font-bold text-red-500" id="total-liabilities">R$ 0,00</span></p>
                                    <p class="text-3xl font-bold mt-2" id="current-net-worth">R$ 0,00</p>
                                </div>
                                <div class="mt-6">
                                    <h3 class="font-bold text-lg mb-2 text-center">Evolução do Patrimônio Líquido</h3>
                                    <div class="chart-container">
                                        <canvas id="netWorthChart"></canvas>
                                    </div>
                                    <div id="net-worth-history-list" class="space-y-2 mt-4 max-h-40 overflow-y-auto pr-2">
                                        <!-- Histórico de registros será exibido aqui -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </main>

            <footer class="text-center mt-12 text-sm text-slate-500">
                <p>Ferramenta interativa para te ajudar a conquistar sua liberdade financeira.</p>
            </footer>
        </section>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Gerenciamento de Estado
            const state = {
                income: 0,
                expenses: [],
                debts: [],
                goals: [],
                activeSection: 'passo1', // Seção ativa padrão
                debtStrategy: 'snowball', // Estratégia de dívida padrão
                essentialCosts: 0, // Custo essencial para cálculo da reserva
                extraPayment: 0, // Para o simulador de dívidas
                // Novos estados para simuladores
                investment: {
                    initialCapital: 0,
                    monthlyContribution: 0,
                    annualInterestRate: 0,
                    periodYears: 0
                },
                financing: {
                    propertyValue: 0,
                    downPaymentPercentage: 0,
                    annualFinancingRate: 0,
                    periodYears: 0
                },
                // Novos estados para Previsão de Fluxo de Caixa
                futureEvents: [],
                projectionSettings: {
                    startMonth: new Date().getMonth() + 1, // Mês atual (1-12)
                    startYear: new Date().getFullYear(), // Ano atual
                    months: 12 // Padrão de 12 meses
                },
                // Novos estados para Patrimônio Líquido
                assets: [],
                liabilities: [],
                netWorthHistory: [] // [{ date: 'YYYY-MM-DD', value: 1234.56 }]
            };

            // Carregar estado salvo do localStorage
            const savedState = localStorage.getItem('financasAppState');
            if (savedState) {
                try {
                    const parsedState = JSON.parse(savedState);
                    // Atribuir valores carregados com fallbacks seguros
                    state.income = parsedState.income !== undefined ? parsedState.income : 0;
                    state.expenses = Array.isArray(parsedState.expenses) ? parsedState.expenses : [];
                    state.debts = Array.isArray(parsedState.debts) ? parsedState.debts : [];
                    state.goals = Array.isArray(parsedState.goals) ? parsedState.goals : [];
                    state.activeSection = parsedState.activeSection || 'passo1';
                    state.debtStrategy = parsedState.debtStrategy || 'snowball';
                    state.essentialCosts = parsedState.essentialCosts !== undefined ? parsedState.essentialCosts : 0;
                    state.extraPayment = parsedState.extraPayment !== undefined ? parsedState.extraPayment : 0;
                    state.investment = parsedState.investment || { initialCapital: 0, monthlyContribution: 0, annualInterestRate: 0, periodYears: 0 };
                    state.financing = parsedState.financing || { propertyValue: 0, downPaymentPercentage: 0, annualFinancingRate: 0, periodYears: 0 };
                    state.futureEvents = Array.isArray(parsedState.futureEvents) ? parsedState.futureEvents : [];
                    // Garantir que a data dos eventos futuros seja carregada como objeto Date
                    state.futureEvents.forEach(event => {
                        if (typeof event.date === 'string') {
                            event.date = new Date(event.date);
                        }
                    });
                    state.projectionSettings = parsedState.projectionSettings || { startMonth: new Date().getMonth() + 1, startYear: new Date().getFullYear(), months: 12 };
                    // Carregar novos estados de Patrimônio Líquido
                    state.assets = Array.isArray(parsedState.assets) ? parsedState.assets : [];
                    state.liabilities = Array.isArray(parsedState.liabilities) ? parsedState.liabilities : [];
                    state.netWorthHistory = Array.isArray(parsedState.netWorthHistory) ? parsedState.netWorthHistory : [];
                    state.netWorthHistory.forEach(item => {
                        if (typeof item.date === 'string') {
                            item.date = new Date(item.date);
                        }
                    });

                } catch (e) {
                    console.error("Erro ao carregar dados do localStorage:", e);
                    // Se a análise falhar, o estado permanece o padrão inicializado
                }
            }

            // Instâncias de Gráficos
            let budgetChart;
            let cashFlowChart;
            let netWorthChart; 

            // Elementos do DOM
            const navButtons = document.querySelectorAll('.nav-button');
            const contentSections = document.querySelectorAll('.content-section');
            const incomeInput = document.getElementById('income');
            const addExpenseBtn = document.getElementById('add-expense');
            const expenseNameInput = document.getElementById('expense-name');
            const expenseAmountInput = document.getElementById('expense-amount');
            const expenseCategoryInput = document.getElementById('expense-category');
            const expenseList = document.getElementById('expense-list');
            const summaryEl = document.getElementById('summary');
            const comparisonBarsEl = document.getElementById('comparison-bars');
            
            const addDebtBtn = document.getElementById('add-debt');
            const debtNameInput = document.getElementById('debt-name');
            const debtTotalInput = document.getElementById('debt-total');
            const debtRateInput = document.getElementById('debt-rate');
            const debtListEl = document.getElementById('debt-list');
            const snowballBtn = document.getElementById('snowball-btn');
            const avalancheBtn = document.getElementById('avalanche-btn');
            const strategyExplanationEl = document.getElementById('strategy-explanation');
            const extraPaymentInput = document.getElementById('extra-payment');
            const debtSimulationResultEl = document.getElementById('debt-simulation-result');

            const essentialCostsInput = document.getElementById('essential-costs');
            const emergencyFundResultEl = document.getElementById('emergency-fund-result');

            const addGoalBtn = document.getElementById('add-goal');
            const goalNameInput = document.getElementById('goal-name');
            const goalTargetAmountInput = document.getElementById('goal-target-amount');
            const goalSavedAmountInput = document.getElementById('goal-saved-amount');
            const goalListEl = document.getElementById('goal-list');

            const initialCapitalInput = document.getElementById('initial-capital');
            const monthlyContributionInput = document.getElementById('monthly-contribution');
            const annualInterestRateInput = document.getElementById('annual-interest-rate');
            const investmentPeriodYearsInput = document.getElementById('investment-period-years');
            const calculateInvestmentBtn = document.getElementById('calculate-investment');
            const investmentResultEl = document.getElementById('investment-result');

            const propertyValueInput = document.getElementById('property-value');
            const downPaymentPercentageInput = document.getElementById('down-payment-percentage');
            const annualFinancingRateInput = document.getElementById('annual-financing-rate');
            const financingPeriodYearsInput = document.getElementById('financing-period-years');
            const calculateFinancingBtn = document.getElementById('calculate-financing');
            const financingResultEl = document.getElementById('financing-result');

            const eventNameInput = document.getElementById('event-name');
            const eventAmountInput = document.getElementById('event-amount');
            const eventDateInput = document.getElementById('event-date');
            const eventTypeInput = document.getElementById('event-type');
            const addFutureEventBtn = document.getElementById('add-future-event');
            const futureEventListEl = document.getElementById('future-event-list');
            const projectionStartMonthSelect = document.getElementById('projection-start-month');
            const projectionStartYearInput = document.getElementById('projection-start-year');
            const projectionMonthsInput = document.getElementById('projection-months');
            const calculateCashFlowBtn = document.getElementById('calculate-cash-flow');
            const projectionTableBody = document.getElementById('projection-table-body');
            const cashFlowChartCanvas = document.getElementById('cashFlowChart');

            // Elementos para Patrimônio Líquido
            const assetNameInput = document.getElementById('asset-name');
            const assetValueInput = document.getElementById('asset-value');
            const addAssetBtn = document.getElementById('add-asset');
            const assetListEl = document.getElementById('asset-list');

            const liabilityNameInput = document.getElementById('liability-name');
            const liabilityValueInput = document.getElementById('liability-value');
            const addLiabilityBtn = document.getElementById('add-liability');
            const liabilityListEl = document.getElementById('liability-list');

            const totalAssetsEl = document.getElementById('total-assets');
            const totalLiabilitiesEl = document.getElementById('total-liabilities');
            const currentNetWorthEl = document.getElementById('current-net-worth');
            const recordNetWorthBtn = document.getElementById('record-net-worth');
            const netWorthChartCanvas = document.getElementById('netWorthChart');
            const netWorthHistoryListEl = document.getElementById('net-worth-history-list');

            // Botão de Reiniciar (se existir no HTML)
            const resetDataBtn = document.getElementById('reset-data-btn');

            // Função para Salvar o Estado
            const saveState = () => {
                localStorage.setItem('financasAppState', JSON.stringify(state));
            };

            // Funções de Renderização
            const renderExpenses = () => {
                expenseList.innerHTML = '';
                if (state.expenses.length === 0) {
                    expenseList.innerHTML = '<p class="text-slate-400 text-center">Nenhuma despesa adicionada.</p>';
                } else {
                    state.expenses.forEach((exp, index) => {
                        const expEl = document.createElement('div');
                        expEl.className = 'flex justify-between items-center bg-gray-100 p-2 rounded-lg text-sm';
                        expEl.innerHTML = `
                            <span>${exp.name} (${exp.category})</span>
                            <div class="flex items-center gap-2">
                                <span class="font-medium">R$ ${exp.amount.toFixed(2)}</span>
                                <button data-index="${index}" class="remove-expense text-red-500 hover:text-red-700 text-lg">&times;</button>
                            </div>
                        `;
                        expenseList.appendChild(expEl);
                    });
                }
            };

            const renderChartAndSummary = () => {
                const totals = {
                    necessidades: 0,
                    desejos: 0,
                    dividas: 0,
                };
                let totalExpenses = 0;
                state.expenses.forEach(exp => {
                    totals[exp.category] += exp.amount;
                    totalExpenses += exp.amount;
                });

                const balance = state.income - totalExpenses;
                summaryEl.textContent = `Saldo: R$ ${balance.toFixed(2)}`;
                summaryEl.classList.toggle('text-red-500', balance < 0);
                summaryEl.classList.toggle('text-green-600', balance >= 0);

                // Atualizar Gráfico
                if (!budgetChart) {
                    const ctx = document.getElementById('budgetChart').getContext('2d');
                    budgetChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Necessidades', 'Desejos', 'Dívidas'],
                            datasets: [{
                                data: [totals.necessidades, totals.desejos, totals.dividas],
                                backgroundColor: ['#34D399', '#FBBF24', '#F87171'],
                                borderWidth: 0,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'bottom' },
                            },
                            cutout: '60%'
                        }
                    });
                } else {
                    budgetChart.data.datasets[0].data = [totals.necessidades, totals.desejos, totals.dividas];
                    budgetChart.update();
                }
                
                // Atualizar Barras de Comparação
                comparisonBarsEl.innerHTML = '';
                const income = state.income > 0 ? state.income : 1;
                const percentages = {
                    necessidades: (totals.necessidades / income) * 100,
                    desejos: (totals.desejos / income) * 100,
                    poupanca: (balance > 0 ? balance / income : 0) * 100,
                };

                const createBar = (label, userPercent, targetPercent, color) => {
                    const barHtml = `
                        <div class="mb-2">
                            <div class="flex justify-between mb-1">
                                <span>${label}</span>
                                <span>${userPercent.toFixed(1)}% (Meta: ${targetPercent}%)</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div class="h-2.5 rounded-full" style="width: ${Math.min(userPercent, 100)}%; background-color: ${color};"></div>
                            </div>
                        </div>
                    `;
                    comparisonBarsEl.innerHTML += barHtml;
                }

                createBar('Necessidades', percentages.necessidades, 50, '#34D399');
                createBar('Desejos', percentages.desejos, 30, '#FBBF24');
                createBar('Poupança/Saldo', percentages.poupanca, 20, '#60A5FA');
            };
            
            const renderDebts = () => {
                debtListEl.innerHTML = '';
                if (state.debts.length === 0) {
                    debtListEl.innerHTML = '<p class="text-slate-400 text-center p-4">Nenhuma dívida adicionada.</p>';
                    return;
                }

                let sortedDebts = [...state.debts];
                if (state.debtStrategy === 'snowball') {
                    sortedDebts.sort((a, b) => a.total - b.total);
                } else { // avalanche
                    sortedDebts.sort((a, b) => b.rate - a.rate);
                }

                sortedDebts.forEach((debt, index) => {
                    const debtEl = document.createElement('div');
                    debtEl.className = 'debt-item flex justify-between items-center p-3';
                    if (index === 0) debtEl.classList.add('bg-emerald-100', 'rounded-lg');
                    
                    debtEl.innerHTML = `
                        <div>
                            <p class="font-bold">${index + 1}. ${debt.name}</p>
                            <p class="text-sm text-slate-600">Total: R$ ${debt.total.toFixed(2)} | Juros: ${debt.rate}% a.m.</p>
                        </div>
                        <button data-id="${debt.id}" class="remove-debt text-red-500 hover:text-red-700 text-lg">&times;</button>
                    `;
                    debtListEl.appendChild(debtEl);
                });
                simulateDebtPayment(); // Chamar a simulação sempre que as dívidas forem renderizadas
            };

            const simulateDebtPayment = () => {
                const extraPayment = state.extraPayment;
                const sortedDebts = [...state.debts]; // Obter a lista de dívidas ordenada pela estratégia atual
                if (state.debtStrategy === 'snowball') {
                    sortedDebts.sort((a, b) => a.total - b.total);
                } else { // avalanche
                    sortedDebts.sort((a, b) => b.rate - a.rate);
                }

                if (sortedDebts.length === 0 || extraPayment <= 0) {
                    debtSimulationResultEl.innerHTML = 'Adicione dívidas e um valor extra para simular.';
                    return;
                }

                let totalMonths = 0;
                let remainingDebt = sortedDebts[0].total;
                let monthlyRate = sortedDebts[0].rate / 100; // Converter % para decimal
                let currentExtraPayment = extraPayment;

                // Simulação de quitação de dívida mais precisa (para uma dívida)
                if (monthlyRate > 0) {
                    // Se o pagamento extra for menor ou igual ao juro mensal da dívida, ela nunca será quitada ou levará muito tempo
                    if (currentExtraPayment <= remainingDebt * monthlyRate && remainingDebt > 0) {
                        debtSimulationResultEl.innerHTML = `Com R$ ${extraPayment.toFixed(2)} extra, levaria muito tempo ou a dívida não diminuiria.`;
                        return;
                    }
                    // Calcula o número de meses usando a fórmula de amortização
                    // n = -log(1 - (i * P) / M) / log(1 + i)
                    // Onde: i = taxa de juros mensal, P = principal, M = pagamento mensal (aqui, o extra)
                    if (currentExtraPayment > 0) { // Garante que o pagamento não é zero
                        totalMonths = -Math.log(1 - (monthlyRate * remainingDebt) / currentExtraPayment) / Math.log(1 + monthlyRate);
                    } else { // Se currentExtraPayment for 0, a dívida não será paga
                        totalMonths = Infinity;
                    }
                } else { // Sem juros
                    if (currentExtraPayment > 0) {
                        totalMonths = remainingDebt / currentExtraPayment;
                    } else {
                        totalMonths = Infinity;
                    }
                }
                
                if (totalMonths > 0 && totalMonths < Infinity && totalMonths < 360) { // Limite de 360 meses (30 anos)
                    const years = Math.floor(totalMonths / 12);
                    const monthsRemainder = Math.round(totalMonths % 12);
                    let resultText = `Com <strong>R$ ${extraPayment.toFixed(2)} extra</strong>, você quitaria a dívida prioritária em `;
                    if (years > 0) {
                        resultText += `<strong>${years} ano(s)</strong> e `;
                    }
                    resultText += `<strong>${monthsRemainder} mês(es)</strong>.`;
                    debtSimulationResultEl.innerHTML = resultText;
                } else if (totalMonths >= 360) {
                    debtSimulationResultEl.innerHTML = `Com <strong>R$ ${extraPayment.toFixed(2)} extra</strong>, levaria mais de 30 anos para quitar a dívida prioritária. Considere renegociar!`;
                } else {
                    debtSimulationResultEl.innerHTML = 'Adicione um valor extra para simular.';
                }
            };

            const renderEmergencyFundResult = () => {
                const costs = state.essentialCosts;
                const minFund = costs * 3;
                const maxFund = costs * 6;
                emergencyFundResultEl.innerHTML = `
                    <p class="font-bold">Sua meta de reserva é:</p>
                    <p class="text-2xl font-bold">R$ ${minFund.toFixed(2)} - R$ ${maxFund.toFixed(2)}</p>
                `;
            };

            const renderGoals = () => {
                goalListEl.innerHTML = '';
                if(state.goals.length === 0) {
                    goalListEl.innerHTML = '<p class="text-slate-400 text-center">Nenhuma meta adicionada.</p>';
                } else {
                    state.goals.forEach((goal, index) => {
                        const percentage = goal.targetAmount > 0 ? (goal.savedAmount / goal.targetAmount) * 100 : 0;
                        const goalEl = document.createElement('div');
                        goalEl.className = 'bg-gray-100 p-3 rounded-lg flex flex-col';
                        goalEl.innerHTML = `
                            <div class="flex justify-between items-center mb-2">
                                <span>${goal.name} - <strong>R$ ${goal.savedAmount.toFixed(2)} / R$ ${goal.targetAmount.toFixed(2)}</strong></span>
                                <button data-id="${goal.id}" class="remove-goal text-red-500 hover:text-red-700 text-lg">&times;</button>
                            </div>
                            <div class="goal-progress-bar">
                                <div class="goal-progress" style="width: ${Math.min(percentage, 100)}%;"></div>
                            </div>
                            <p class="text-sm text-slate-600 mt-1">Progresso: <strong>${percentage.toFixed(1)}%</strong></p>
                            <div class="mt-2 text-sm">
                                <label for="goal-saved-input-${index}" class="block font-medium mb-1">Atualizar Economizado:</label>
                                <input type="number" id="goal-saved-input-${index}" data-id="${goal.id}" value="${goal.savedAmount}"
                                        class="w-full p-1 border rounded-lg text-sm update-goal-saved-amount">
                            </div>
                        `;
                        goalListEl.appendChild(goalEl);
                    });
                }
            };

            const calculateInvestment = () => {
                const initialCapital = parseFloat(initialCapitalInput.value) || 0;
                const monthlyContribution = parseFloat(monthlyContributionInput.value) || 0;
                const annualRate = parseFloat(annualInterestRateInput.value) || 0;
                const periodYears = parseFloat(investmentPeriodYearsInput.value) || 0;

                state.investment = { initialCapital, monthlyContribution, annualInterestRate: annualRate, periodYears };
                saveState();

                if ((initialCapital <= 0 && monthlyContribution <= 0) || periodYears <= 0) {
                    investmentResultEl.innerHTML = '<p>Preencha os campos para ver a simulação do seu investimento.</p>';
                    return;
                }

                const monthlyRate = annualRate / 100 / 12;
                const totalMonths = periodYears * 12;

                let futureValue = initialCapital * Math.pow((1 + monthlyRate), totalMonths);
                if (monthlyContribution > 0) {
                    // Future value of a series of payments (annuity due, as payment is at the beginning of the period)
                    // FV = P * [((1 + r)^n - 1) / r] * (1 + r)
                    futureValue += monthlyContribution * ((Math.pow((1 + monthlyRate), totalMonths) - 1) / monthlyRate) * (1 + monthlyRate);
                }

                const totalInvested = initialCapital + (monthlyContribution * totalMonths);
                const totalInterest = futureValue - totalInvested;

                investmentResultEl.innerHTML = `
                    <p class="font-bold">Valor Total Acumulado: <span class="text-emerald-600">R$ ${futureValue.toFixed(2)}</span></p>
                    <p class="text-sm text-slate-600">Total Investido: R$ ${totalInvested.toFixed(2)}</p>
                    <p class="text-sm text-slate-600">Juros Ganhos: R$ ${totalInterest.toFixed(2)}</p>
                `;
            };

            const calculateFinancing = () => {
                const propertyValue = parseFloat(propertyValueInput.value) || 0;
                const downPaymentPercentage = parseFloat(downPaymentPercentageInput.value) || 0;
                const annualRate = parseFloat(annualFinancingRateInput.value) || 0;
                const periodYears = parseFloat(financingPeriodYearsInput.value) || 0;

                state.financing = { propertyValue, downPaymentPercentage, annualFinancingRate: annualRate, periodYears };
                saveState();

                if (propertyValue <= 0 || periodYears <= 0) {
                    financingResultEl.innerHTML = '<p>Preencha os campos de valor do bem e período para simular seu financiamento.</p>';
                    return;
                }

                const downPayment = propertyValue * (downPaymentPercentage / 100);
                const loanAmount = propertyValue - downPayment;

                if (loanAmount <= 0) {
                    financingResultEl.innerHTML = '<p>O valor da entrada é igual ou maior que o valor do bem. Não há financiamento necessário.</p>';
                    return;
                }

                const monthlyRate = annualRate / 100 / 12;
                const totalMonths = periodYears * 12;

                let monthlyPayment = 0;
                if (monthlyRate > 0) {
                    // Formula para Tabela Price (PMT = P * [i * (1 + i)^n] / [(1 + i)^n – 1])
                    monthlyPayment = loanAmount * (monthlyRate * Math.pow((1 + monthlyRate), totalMonths)) / (Math.pow((1 + monthlyRate), totalMonths) - 1);
                } else {
                    monthlyPayment = loanAmount / totalMonths; // Sem juros
                }

                const totalPaid = monthlyPayment * totalMonths;
                const totalInterest = totalPaid - loanAmount;

                financingResultEl.innerHTML = `
                    <p class="font-bold">Valor da Parcela Mensal: <span class="text-emerald-600">R$ ${monthlyPayment.toFixed(2)}</span></p>
                    <p class="text-sm text-slate-600">Valor Financiado: R$ ${loanAmount.toFixed(2)}</p>
                    <p class="text-sm text-slate-600">Custo Total do Financiamento (com juros): <span class="text-red-500">R$ ${totalPaid.toFixed(2)}</span></p>
                    <p class="text-sm text-slate-600">Total de Juros Pagos: R$ ${totalInterest.toFixed(2)}</p>
                `;
            };

            const renderFutureEvents = () => {
                futureEventListEl.innerHTML = '';
                if (state.futureEvents.length === 0) {
                    futureEventListEl.innerHTML = '<p class="text-slate-400 text-center">Nenhum evento futuro adicionado.</p>';
                } else {
                    state.futureEvents.sort((a, b) => a.date - b.date).forEach((event, index) => {
                        const eventEl = document.createElement('div');
                        eventEl.className = 'flex justify-between items-center bg-gray-100 p-2 rounded-lg text-sm';
                        const eventDate = new Date(event.date); // Ensure it's a Date object
                        eventEl.innerHTML = `
                            <span>${event.name} (${eventDate.toLocaleDateString('pt-BR')})</span>
                            <div class="flex items-center gap-2">
                                <span class="font-medium ${event.type === 'income' ? 'text-green-600' : 'text-red-500'}">
                                    ${event.type === 'income' ? '+' : '-'} R$ ${event.amount.toFixed(2)}
                                </span>
                                <button data-id="${event.id}" class="remove-future-event text-red-500 hover:text-red-700 text-lg">&times;</button>
                            </div>
                        `;
                        futureEventListEl.appendChild(eventEl);
                    });
                }
            };

            const calculateCashFlowProjection = () => {
                const startMonth = parseInt(projectionStartMonthSelect.value);
                const startYear = parseInt(projectionStartYearInput.value);
                const numMonths = parseInt(projectionMonthsInput.value);

                state.projectionSettings = { startMonth, startYear, months: numMonths };
                saveState();

                if (numMonths <= 0) {
                    projectionTableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-slate-400">Gere a projeção para visualizar.</td></tr>';
                    // Clear chart if no months to project
                    if (cashFlowChart) {
                        cashFlowChart.destroy();
                        cashFlowChart = null;
                    }
                    return;
                }

                // Calculate current monthly net income from Passo 1 expenses
                let totalMonthlyExpensesFromBudget = 0;
                state.expenses.forEach(exp => {
                    totalMonthlyExpensesFromBudget += exp.amount;
                });
                const monthlyNetIncomeFromBudget = state.income - totalMonthlyExpensesFromBudget;

                // Initial balance for projection: current income minus current expenses
                // This assumes the projection starts with the current month's calculated balance
                let currentBalance = state.income - totalMonthlyExpensesFromBudget; 

                projectionTableBody.innerHTML = ''; // Clear previous projection

                const monthsNames = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];

                const labels = [];
                const incomeData = [];
                const expenseData = [];
                const balanceData = [];

                for (let i = 0; i < numMonths; i++) {
                    let projectionDate = new Date(startYear, startMonth - 1 + i, 1); // Month is 0-indexed for Date object
                    let monthLabel = `${monthsNames[projectionDate.getMonth()]}/${projectionDate.getFullYear()}`;
                    labels.push(monthLabel);

                    let monthStartBalance = currentBalance; // Balance at the start of THIS month

                    let monthIncomeEvents = 0;
                    let monthExpenseEvents = 0;

                    // Apply future events for this specific month
                    state.futureEvents.forEach(event => {
                        const eventDate = new Date(event.date);
                        if (eventDate.getFullYear() === projectionDate.getFullYear() && eventDate.getMonth() === projectionDate.getMonth()) {
                            if (event.type === 'income') {
                                monthIncomeEvents += event.amount;
                            } else {
                                monthExpenseEvents += event.amount;
                            }
                        }
                    });

                    // Calculate total income and expenses for the month
                    const totalMonthlyIncome = state.income + monthIncomeEvents; // Regular income + event income
                    const totalMonthlyExpenses = totalMonthlyExpensesFromBudget + monthExpenseEvents; // Regular expenses + event expenses
                    
                    // The end balance for the current month becomes the start balance for the next month
                    currentBalance = monthStartBalance + totalMonthlyIncome - totalMonthlyExpenses;

                    incomeData.push(totalMonthlyIncome);
                    expenseData.push(totalMonthlyExpenses);
                    balanceData.push(currentBalance); // This is the balance at the end of the month

                    const row = document.createElement('tr');
                    row.className = 'border-b last:border-b-0';
                    row.innerHTML = `
                        <td class="py-2 px-3">${monthLabel}</td>
                        <td class="py-2 px-3">R$ ${monthStartBalance.toFixed(2)}</td>
                        <td class="py-2 px-3 text-green-600">R$ ${totalMonthlyIncome.toFixed(2)}</td>
                        <td class="py-2 px-3 text-red-500">R$ ${totalMonthlyExpenses.toFixed(2)}</td>
                        <td class="py-2 px-3 font-bold ${currentBalance < 0 ? 'text-red-600' : 'text-emerald-600'}">R$ ${currentBalance.toFixed(2)}</td>
                    `;
                    projectionTableBody.appendChild(row);
                }

                // Renderizar Gráfico de Fluxo de Caixa
                if (cashFlowChart) {
                    cashFlowChart.destroy(); // Destruir instância anterior para evitar duplicidade
                }
                const ctx = cashFlowChartCanvas.getContext('2d');
                cashFlowChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Receitas Totais',
                                data: incomeData,
                                borderColor: '#34D399', // Emerald 500
                                backgroundColor: 'rgba(52, 211, 153, 0.2)',
                                fill: true,
                                tension: 0.3
                            },
                            {
                                label: 'Despesas Totais',
                                data: expenseData,
                                borderColor: '#EF4444', // Red 500
                                backgroundColor: 'rgba(239, 68, 68, 0.2)',
                                fill: true,
                                tension: 0.3
                            },
                            {
                                label: 'Saldo Final',
                                data: balanceData,
                                borderColor: '#60A5FA', // Blue 500
                                backgroundColor: 'rgba(96, 165, 250, 0.2)',
                                fill: false,
                                tension: 0.3,
                                borderWidth: 2
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += 'R$ ' + context.parsed.y.toFixed(2);
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                title: {
                                    display: true,
                                    text: 'Valor (R$)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Mês/Ano'
                                }
                            }
                        }
                    }
                });
            };

            const calculateNetWorth = () => {
                let totalAssets = state.assets.reduce((sum, asset) => sum + asset.value, 0);
                let totalLiabilities = state.liabilities.reduce((sum, liability) => sum + liability.value, 0);
                let currentNetWorth = totalAssets - totalLiabilities;

                totalAssetsEl.textContent = `R$ ${totalAssets.toFixed(2)}`;
                totalLiabilitiesEl.textContent = `R$ ${totalLiabilities.toFixed(2)}`;
                currentNetWorthEl.textContent = `R$ ${currentNetWorth.toFixed(2)}`;
                currentNetWorthEl.classList.toggle('text-red-500', currentNetWorth < 0);
                currentNetWorthEl.classList.toggle('text-emerald-600', currentNetWorth >= 0);

                renderNetWorthHistory();
            };

            const renderAssets = () => {
                assetListEl.innerHTML = '';
                if (state.assets.length === 0) {
                    assetListEl.innerHTML = '<p class="text-slate-400 text-center">Nenhum ativo adicionado.</p>';
                } else {
                    state.assets.forEach((asset, index) => {
                        const assetEl = document.createElement('div');
                        assetEl.className = 'flex justify-between items-center bg-gray-100 p-2 rounded-lg text-sm';
                        assetEl.innerHTML = `
                            <span>${asset.name}</span>
                            <div class="flex items-center gap-2">
                                <span class="font-medium text-emerald-600">R$ ${asset.value.toFixed(2)}</span>
                                <button data-id="${asset.id}" class="remove-asset text-red-500 hover:text-red-700 text-lg">&times;</button>
                            </div>
                        `;
                        assetListEl.appendChild(assetEl);
                    });
                }
            };

            const renderLiabilities = () => {
                liabilityListEl.innerHTML = '';
                if (state.liabilities.length === 0) {
                    liabilityListEl.innerHTML = '<p class="text-slate-400 text-center">Nenhum passivo adicionado.</p>';
                } else {
                    state.liabilities.forEach((liability, index) => {
                        const liabilityEl = document.createElement('div');
                        liabilityEl.className = 'flex justify-between items-center bg-gray-100 p-2 rounded-lg text-sm';
                        liabilityEl.innerHTML = `
                            <span>${liability.name}</span>
                            <div class="flex items-center gap-2">
                                <span class="font-medium text-red-500">R$ ${liability.value.toFixed(2)}</span>
                                <button data-id="${liability.id}" class="remove-liability text-red-500 hover:text-red-700 text-lg">&times;</button>
                            </div>
                        `;
                        liabilityListEl.appendChild(liabilityEl);
                    });
                }
            };

            const renderNetWorthHistory = () => {
                netWorthHistoryListEl.innerHTML = '';
                if (state.netWorthHistory.length === 0) {
                    netWorthHistoryListEl.innerHTML = '<p class="text-slate-400 text-center">Nenhum registro de patrimônio.</p>';
                } else {
                    state.netWorthHistory.sort((a, b) => b.date - a.date).forEach(item => { // Sort descending by date
                        const historyEl = document.createElement('div');
                        historyEl.className = 'flex justify-between items-center bg-gray-100 p-2 rounded-lg text-sm';
                        const itemDate = new Date(item.date);
                        historyEl.innerHTML = `
                            <span>${itemDate.toLocaleDateString('pt-BR')}</span>
                            <span class="font-medium ${item.value < 0 ? 'text-red-600' : 'text-emerald-600'}">R$ ${item.value.toFixed(2)}</span>
                        `;
                        netWorthHistoryListEl.appendChild(historyEl);
                    });
                }

                // Renderizar Gráfico de Patrimônio Líquido
                if (netWorthChart) {
                    netWorthChart.destroy();
                }

                const labels = state.netWorthHistory.map(item => new Date(item.date).toLocaleDateString('pt-BR'));
                const data = state.netWorthHistory.map(item => item.value);

                const ctx = netWorthChartCanvas.getContext('2d');
                netWorthChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Patrimônio Líquido',
                            data: data,
                            borderColor: '#10B981', // Emerald 500
                            backgroundColor: 'rgba(16, 185, 129, 0.2)',
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false,
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += 'R$ ' + context.parsed.y.toFixed(2);
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                title: {
                                    display: true,
                                    text: 'Valor (R$)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Data'
                                }
                            }
                        }
                    }
                });
            };

            // Função de Atualização Completa do UI
            const updateAll = () => {
                renderExpenses();
                renderChartAndSummary();
                renderDebts();
                renderEmergencyFundResult();
                renderGoals();
                renderFutureEvents();
                renderAssets(); // Renderizar ativos
                renderLiabilities(); // Renderizar passivos
                calculateNetWorth(); // Calcular e renderizar patrimônio líquido

                // Atualizar campos de input com o estado carregado
                incomeInput.value = state.income;
                essentialCostsInput.value = state.essentialCosts;
                extraPaymentInput.value = state.extraPayment;

                initialCapitalInput.value = state.investment.initialCapital;
                monthlyContributionInput.value = state.investment.monthlyContribution;
                annualInterestRateInput.value = state.investment.annualInterestRate;
                investmentPeriodYearsInput.value = state.investment.periodYears;

                propertyValueInput.value = state.financing.propertyValue;
                downPaymentPercentageInput.value = state.financing.downPaymentPercentage;
                annualFinancingRateInput.value = state.financing.annualFinancingRate;
                financingPeriodYearsInput.value = state.financing.periodYears;

                projectionStartMonthSelect.value = state.projectionSettings.startMonth;
                projectionStartYearInput.value = state.projectionSettings.startYear;
                projectionMonthsInput.value = state.projectionSettings.months;

                // Definir botão de navegação e seção ativa
                navButtons.forEach(btn => btn.classList.remove('active'));
                const activeButton = document.querySelector(`.nav-button[data-target="${state.activeSection}"]`);
                if (activeButton) {
                    activeButton.classList.add('active');
                }
                contentSections.forEach(section => {
                    section.classList.toggle('active', section.id === state.activeSection);
                });

                // Atualizar estado dos botões de estratégia de dívida
                if (state.debtStrategy === 'snowball') {
                    snowballBtn.classList.add('bg-emerald-200', 'text-emerald-800');
                    snowballBtn.classList.remove('bg-gray-200');
                    avalancheBtn.classList.add('bg-gray-200');
                    avalancheBtn.classList.remove('bg-emerald-200', 'text-emerald-800');
                    strategyExplanationEl.innerHTML = "<b>Método Bola de Neve:</b> Pague as dívidas da menor para a maior. Ideal para ganhar motivação rápida.";
                } else {
                    avalancheBtn.classList.add('bg-emerald-200', 'text-emerald-800');
                    avalancheBtn.classList.remove('bg-gray-200');
                    snowballBtn.classList.add('bg-gray-200');
                    snowballBtn.classList.remove('bg-emerald-200', 'text-emerald-800');
                    strategyExplanationEl.innerHTML = "<b>Método Avalancha:</b> Pague as dívidas com maiores juros primeiro. Ideal para economizar mais dinheiro.";
                }
            };

            // Listeners de Eventos
            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const target = button.dataset.target;
                    state.activeSection = target;
                    saveState();
                    updateAll();
                    if (target === 'passo4-investimento') {
                        calculateInvestment();
                    } else if (target === 'passo5-financiamento') {
                        calculateFinancing();
                    } else if (target === 'passo6-fluxo-caixa') {
                        populateMonthYearSelectors();
                        calculateCashFlowProjection();
                    } else if (target === 'passo7-patrimonio') {
                        calculateNetWorth(); 
                    }
                });
            });

            incomeInput.addEventListener('input', (e) => {
                state.income = parseFloat(e.target.value) || 0;
                saveState();
                renderChartAndSummary();
            });

            addExpenseBtn.addEventListener('click', () => {
                const name = expenseNameInput.value.trim();
                const amount = parseFloat(expenseAmountInput.value);
                const category = expenseCategoryInput.value;

                if (name && amount > 0) {
                    state.expenses.push({ id: Date.now(), name, amount, category });
                    expenseNameInput.value = '';
                    expenseAmountInput.value = '';
                    saveState();
                    updateAll();
                }
            });

            expenseList.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-expense')) {
                    const index = parseInt(e.target.dataset.index); 
                    state.expenses.splice(index, 1);
                    saveState();
                    updateAll();
                }
            });
            
            addDebtBtn.addEventListener('click', () => {
                const name = debtNameInput.value.trim();
                const total = parseFloat(debtTotalInput.value);
                const rate = parseFloat(debtRateInput.value);
                if (name && total > 0 && rate >= 0) {
                    state.debts.push({ id: Date.now(), name, total, rate });
                    debtNameInput.value = '';
                    debtTotalInput.value = '';
                    debtRateInput.value = '';
                    saveState();
                    renderDebts();
                }
            });

            debtListEl.addEventListener('click', e => {
                if(e.target.classList.contains('remove-debt')) {
                    const id = parseInt(e.target.dataset.id);
                    state.debts = state.debts.filter(d => d.id !== id);
                    saveState();
                    renderDebts();
                }
            });

            snowballBtn.addEventListener('click', () => {
                state.debtStrategy = 'snowball';
                saveState();
                updateAll();
            });

            avalancheBtn.addEventListener('click', () => {
                state.debtStrategy = 'avalanche';
                saveState();
                updateAll();
            });

            extraPaymentInput.addEventListener('input', (e) => {
                state.extraPayment = parseFloat(e.target.value) || 0;
                saveState();
                simulateDebtPayment();
            });

            essentialCostsInput.addEventListener('input', (e) => {
                state.essentialCosts = parseFloat(e.target.value) || 0;
                saveState();
                renderEmergencyFundResult();
            });
            
            addGoalBtn.addEventListener('click', () => {
                const name = goalNameInput.value.trim();
                const targetAmount = parseFloat(goalTargetAmountInput.value);
                const savedAmount = parseFloat(goalSavedAmountInput.value) || 0;
                if(name && targetAmount > 0) {
                    state.goals.push({ id: Date.now(), name, targetAmount, savedAmount });
                    goalNameInput.value = '';
                    goalTargetAmountInput.value = '';
                    goalSavedAmountInput.value = '';
                    saveState();
                    renderGoals();
                }
            });

            goalListEl.addEventListener('click', e => {
                if(e.target.classList.contains('remove-goal')) {
                    const id = parseInt(e.target.dataset.id);
                    state.goals = state.goals.filter(g => g.id !== id);
                    saveState();
                    renderGoals();
                }
            });

            goalListEl.addEventListener('input', (e) => {
                if (e.target.classList.contains('update-goal-saved-amount')) {
                    const id = parseInt(e.target.dataset.id);
                    const newSavedAmount = parseFloat(e.target.value) || 0;
                    const goalIndex = state.goals.findIndex(g => g.id === id);
                    if (goalIndex !== -1) {
                        state.goals[goalIndex].savedAmount = newSavedAmount;
                        saveState();
                        renderGoals();
                    }
                }
            });

            // Listeners para Simulador de Investimentos
            initialCapitalInput.addEventListener('input', calculateInvestment);
            monthlyContributionInput.addEventListener('input', calculateInvestment);
            annualInterestRateInput.addEventListener('input', calculateInvestment);
            investmentPeriodYearsInput.addEventListener('input', calculateInvestment);
            calculateInvestmentBtn.addEventListener('click', calculateInvestment);

            // Listeners para Simulador de Financiamento
            propertyValueInput.addEventListener('input', calculateFinancing);
            downPaymentPercentageInput.addEventListener('input', calculateFinancing);
            annualFinancingRateInput.addEventListener('input', calculateFinancing);
            financingPeriodYearsInput.addEventListener('input', calculateFinancing);
            calculateFinancingBtn.addEventListener('click', calculateFinancing);

            // Listeners para Previsão de Fluxo de Caixa
            addFutureEventBtn.addEventListener('click', () => {
                const name = eventNameInput.value.trim();
                const amount = parseFloat(eventAmountInput.value);
                const date = eventDateInput.value;
                const type = eventTypeInput.value;

                if (name && amount > 0 && date) {
                    state.futureEvents.push({ id: Date.now(), name, amount, date: new Date(date), type });
                    eventNameInput.value = '';
                    eventAmountInput.value = '';
                    eventDateInput.value = '';
                    saveState();
                    renderFutureEvents();
                    calculateCashFlowProjection();
                }
            });

            futureEventListEl.addEventListener('click', e => {
                if(e.target.classList.contains('remove-future-event')) {
                    const id = parseInt(e.target.dataset.id);
                    state.futureEvents = state.futureEvents.filter(event => event.id !== id);
                    saveState();
                    renderFutureEvents();
                    calculateCashFlowProjection();
                }
            });

            projectionStartMonthSelect.addEventListener('change', calculateCashFlowProjection);
            projectionStartYearInput.addEventListener('input', calculateCashFlowProjection);
            projectionMonthsInput.addEventListener('input', calculateCashFlowProjection);
            calculateCashFlowBtn.addEventListener('click', calculateCashFlowProjection);

            // Listeners para Patrimônio Líquido
            addAssetBtn.addEventListener('click', () => {
                const name = assetNameInput.value.trim();
                const value = parseFloat(assetValueInput.value);
                if (name && value >= 0) {
                    state.assets.push({ id: Date.now(), name, value });
                    assetNameInput.value = '';
                    assetValueInput.value = '';
                    saveState();
                    renderAssets();
                    calculateNetWorth();
                }
            });

            assetListEl.addEventListener('click', e => {
                if (e.target.classList.contains('remove-asset')) {
                    const id = parseInt(e.target.dataset.id);
                    state.assets = state.assets.filter(asset => asset.id !== id);
                    saveState();
                    renderAssets();
                    calculateNetWorth();
                }
            });

            addLiabilityBtn.addEventListener('click', () => {
                const name = liabilityNameInput.value.trim();
                const value = parseFloat(liabilityValueInput.value);
                if (name && value >= 0) {
                    state.liabilities.push({ id: Date.now(), name, value });
                    liabilityNameInput.value = '';
                    liabilityValueInput.value = '';
                    saveState();
                    renderLiabilities();
                    calculateNetWorth();
                }
            });

            liabilityListEl.addEventListener('click', e => {
                if (e.target.classList.contains('remove-liability')) {
                    const id = parseInt(e.target.dataset.id);
                    state.liabilities = state.liabilities.filter(liability => liability.id !== id);
                    saveState();
                    renderLiabilities();
                    calculateNetWorth();
                }
            });

            recordNetWorthBtn.addEventListener('click', () => {
                let totalAssets = state.assets.reduce((sum, asset) => sum + asset.value, 0);
                let totalLiabilities = state.liabilities.reduce((sum, liability) => sum + liability.value, 0);
                let currentNetWorth = totalAssets - totalLiabilities;
                
                // Add only if there's a change or if it's the first record
                const lastRecord = state.netWorthHistory[state.netWorthHistory.length - 1];
                const today = new Date();
                today.setHours(0, 0, 0, 0); // Normalize date to compare only day, month, year

                if (!lastRecord || lastRecord.value !== currentNetWorth || new Date(lastRecord.date).toDateString() !== today.toDateString()) {
                    state.netWorthHistory.push({ date: today, value: currentNetWorth });
                    saveState();
                    renderNetWorthHistory();
                    // Optionally, provide feedback to the user that it was recorded
                } else {
                    // Optionally, inform the user that net worth hasn't changed or was already recorded today
                }
            });

            // Função para popular os seletores de mês e ano
            const populateMonthYearSelectors = () => {
                const monthsNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
                projectionStartMonthSelect.innerHTML = '';
                monthsNames.forEach((name, index) => {
                    const option = document.createElement('option');
                    option.value = index + 1; // Mês 1-12
                    option.textContent = name;
                    projectionStartMonthSelect.appendChild(option);
                });

                const currentYear = new Date().getFullYear();
                projectionStartYearInput.value = currentYear;
            };

            // Reiniciar Dados (se existir no HTML)
            if (resetDataBtn) {
                resetDataBtn.addEventListener('click', () => {
                    if (confirm("Tem certeza que deseja reiniciar todos os dados? Esta ação não pode ser desfeita.")) {
                        localStorage.removeItem('financasAppState');
                        // Reinicializar o estado para valores padrão
                        state.income = 0;
                        state.expenses = [];
                        state.debts = [];
                        state.goals = [];
                        state.activeSection = 'passo1';
                        state.debtStrategy = 'snowball';
                        state.essentialCosts = 0;
                        state.extraPayment = 0;
                        state.investment = { initialCapital: 0, monthlyContribution: 0, annualInterestRate: 0, periodYears: 0 };
                        state.financing = { propertyValue: 0, downPaymentPercentage: 0, annualFinancingRate: 0, periodYears: 0 };
                        state.futureEvents = [];
                        state.projectionSettings = { startMonth: new Date().getMonth() + 1, startYear: new Date().getFullYear(), months: 12 };
                        state.assets = [];
                        state.liabilities = [];
                        state.netWorthHistory = [];

                        updateAll();
                        populateMonthYearSelectors();
                    }
                });
            }

            // Renderização Inicial com o estado carregado ou padrão
            populateMonthYearSelectors();
            updateAll();
        });
    </script>
</body>
</html>
